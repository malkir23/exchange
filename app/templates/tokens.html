{% extends "base.html" %} {% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/scripts/token.js"></script>
<style>
  body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  background-color: #1e1e2f;
  color: #ffffff;
}

header {
  background-color: #282846;
  padding: 1rem;
  text-align: center;
}

header h1 {
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

nav {
  margin-top: 1rem;
}

.link {
  color: #8a8acb;
  text-decoration: none;
  margin: 0 10px;
  font-weight: 500;
}

.link:hover {
  color: #ffffff;
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  padding: 2rem;
}

@media (max-width: 600px) {
  .dashboard {
    padding: 5px;
  }
}

.card {
  background-color: #282846;
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

@media (max-width: 600px) {
  .card {
    padding: 0;
  }
}

.card h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  margin-bottom: 1rem;
}

.card p {
  font-size: 1.5rem;
  font-weight: 500;
  margin: 0;
}

footer {
  background-color: #1b1b2e;
  padding: 1rem;
  text-align: center;
  margin-top: 2rem;
}

footer p {
  color: #8a8acb;
  font-size: 0.9rem;
}

.tabs {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.tabs button {
  padding: 10px 20px;
  background: #282846;
  border: 2px solid #8a8acb;
  border-radius: 5px;
  color: #8a8acb;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.tabs button:hover {
  background: #1b1b2e;
  color: #ffffff;
  border-color: #ffffff;
}

.tabs button.active {
  background: #007bff;
  color: white;
  border-color: #0056b3;
}

.tab-content {
  display: none;
  background: #282846;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.tab-content.active {
  display: block;
}

.summary {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20%;
  margin: 25px;
}

.summary-card {
  display: flex;
  flex-direction: column; /* –í—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤ card –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
  background-color: #282846;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.summary-card-header {
  display: flex;
  justify-content: space-between; /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ñ span —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –ø–æ –∫—Ä–∞—è—Ö */
  align-items: center; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  width: 100%;
}

.summary-card h3 {
  font-size: 1rem;
  font-weight: 600;
  margin: 0; /* –ó–∞–±–∏—Ä–∞—î–º–æ –∑–∞–π–≤—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ */
}

.summary-card span {
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgb(138 138 203 / 10%);
}

.summary-card p {
  font-size: 1.25rem;
  font-weight: 500;
  margin: 10px 0 0; /* –í—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É */
}

.filters {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px;
}

.filters label {
  font-weight: 500;
}

.filters select {
  padding: 5px 10px;
  background-color: #282846;
  color: #ffffff;
  border: 1px solid #8a8acb;
  border-radius: 5px;
  font-size: 1rem;
}

filters select:focus {
  outline: none;
  border-color: #007bff;
}

#TWAPs-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

#TWAPs-table th, #TWAPs-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #8a8acb;
}

#TWAPs-table th {
  background-color: #1b1b2e;
  color: #ffffff;
  font-weight: 600;
}

#TWAPs-table tbody tr:hover {
  background-color: #1b1b2e;
}

.buy-color{
  color: #00ff00;
}

.sell-color{
  color: #ff0000;
}

@media (max-width: 600px) {
  .dashboard {
    padding: 5px;
  }

  .card {
    padding: 0;
  }
}
.footer {
  background-color: #1b1b2e;
  color: #ffffff;
  padding: 2rem 1rem;
  text-align: center;
  margin-top: 2rem;
}

.footer-container {
  max-width: 800px;
  margin: auto;
  text-align: left;
}

.footer h2, .footer h3 {
  color: #8a8acb;
  margin-bottom: 10px;
}

.footer p {
  font-size: 1rem;
  line-height: 1.6;
  color: #d1d1e0;
}

.footer ul {
  list-style: none;
  padding: 0;
}

.footer ul li {
  font-size: 1rem;
  margin: 5px 0;
  padding-left: 20px;
  position: relative;
}

.footer ul li::before {
  content: "‚Ä¢";
  position: absolute;
  left: 0;
  color: #8a8acb;
  font-size: 1.2rem;
}

@media (max-width: 600px) {
  .footer-container {
    padding: 0 10px;
  }
}

</style>
{% endblock %} {% block title %} Tokens {% endblock %} {% block content %}
<main class="dashboard">
  <div class="card">
    <canvas id="tokensChart" width="400" height="500"></canvas>
  </div>
</main>
<script>
let tokensChart = null;
const TOKEN_URL = '/data';


async function getTokens(tokenData) {
  const allLabels = Object.keys(tokenData).flatMap((token) => {
    return Object.keys(tokenData[token]).filter(
      (key) => key !== '_id' && key !== 'date' && key !== 'totalAmount'
    );
  });
  const uniqueLabels = [...new Set(allLabels)];
  return uniqueLabels;
}

async function getLables(tokenData){
  let dates = Object.keys(tokenData);
  return dates.sort((a, b) => {
    const [dayA, monthA, yearA] = a.split('-').map(Number);
    const [dayB, monthB, yearB] = b.split('-').map(Number);

    if (yearA !== yearB) {
      return yearA - yearB;
    }

    if (monthA !== monthB) {
      return monthA - monthB;
    }

    return dayA - dayB;
  });
}

async function buildChart(tokenData) {
  const labels = await getLables(tokenData) ;
  const tokens = await getTokens(tokenData);
console.log('üöÄ ~ file: token.js ~ line 31 ~ buildChart ~ labels', labels);

  const generateColor = (opacity = 1) => {
    const r = Math.floor(Math.random() * 255);
    const g = Math.floor(Math.random() * 255);
    const b = Math.floor(Math.random() * 255);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  };

  const datasets = tokens.flatMap((token) => {
    const totalValues = labels.map(
      (date) => tokenData[date][token]?.total || 0
    );
    const amountValues = labels.map(
      (date) => tokenData[date][token]?.amount || 0
    );
    const totalAmountValues = labels.map((date) => parseFloat(tokenData[date].totalAmount));

    // const totalColor = generateColor(0.6);
    // const amountColor = generateColor(0.6);
    const totalAmountColor = 'rgba(255, 99, 132, 1)';

    return [
      {
        label: `USDC`,
        data: totalValues,
        borderColor: 'rgba(20, 223, 155, 1)',
        backgroundColor: 'rgba(20, 223, 155, 0.2)',
        borderWidth: 2,
        tension: 0.3,
        fill: true,
        type: 'bar',
      },
      {
        label: `HYPE`,
        data: amountValues,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderWidth: 2,
        tension: 0.3,
        borderDash: [5, 5],
        fill: false,
        type: 'bar',
      },
      {
        label: `AF HYPE`,
        data: totalAmountValues,
        borderColor: totalAmountColor,
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderWidth: 2,
        tension: 0.3,
        borderDash: [2, 2],
        fill: false,
        type: 'line',
        yAxisID: 'y1',
      },
    ];
  });

  const ctx = document.getElementById('tokensChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return (
                context.dataset.label + ': ' + context.raw.toLocaleString()
              );
            },
          },
        },
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Date',
          },
        },
        y: {
          title: {
            display: true,
            text: 'Value',
          },
          beginAtZero: true,
        },
        y1: {
          position: 'right',
          grid: {
            drawOnChartArea: false,
          },
          title: {
            display: true,
            text: 'Total Amount',
          },
        },
      },
    },
  });
}

async function sendPostRequest() {
  try {
    const response = await fetch(TOKEN_URL, { method: 'GET' });
    console.log('‚úÖ Data Fetched Successfully:', response);

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ Data Fetched Successfully:', data['data']);
    await buildChart(data['data']);
  } catch (error) {
    console.error('Error during POST request:', error);
  }
}
$(document).ready(function () {
  sendPostRequest();
  setInterval(sendPostRequest, 3600000); // 3600000 milliseconds = 1 hour
});

</script>
{% endblock %}
